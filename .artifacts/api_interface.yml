# 后端API接口定义
# 12306 火车票订票系统

# 用户认证相关API接口
- type: Backend
  id: API-POST-Login
  route: POST /api/auth/login
  description: 处理用户登录请求，支持用户名/手机号/邮箱登录。
  input:
    type: JSON
    body:
      username: string  # 用户名/手机号/邮箱
      password: string
  output:
    success:
      statusCode: 200
      body: 
        userId: "uuid"
        token: "jwt"
        userInfo:
          username: "string"
          realName: "string"
          phone: "string"
    error:
      - statusCode: 400
        body: { error: "Invalid input format." }
      - statusCode: 401
        body: { error: "Invalid username or password." }
      - statusCode: 429
        body: { error: "Too many login attempts." }
  dependencies:
    - DB-FindUserByCredentials
  acceptanceCriteria:
    - 当接收到合法凭据时，应返回200 OK和JWT令牌。
    - 当凭据无效时，应返回401 Unauthorized。
    - 支持多种登录方式（用户名、手机号、邮箱）。
    - 实现登录失败次数限制。
  changeLog:
    - date: "2025-01-20"
      description: "初始创建。"

- type: Backend
  id: API-POST-Register
  route: POST /api/auth/register
  description: 处理用户注册请求，创建新用户账号。
  input:
    type: JSON
    body:
      username: string
      password: string
      confirmPassword: string
      realName: string
      idType: string
      idNumber: string
      passengerType: string
      phoneNumber: string
      email: string
      agreeTerms: boolean
  output:
    success:
      statusCode: 201
      body: 
        userId: "uuid"
        message: "Registration successful"
    error:
      - statusCode: 400
        body: { error: "Invalid input or password mismatch." }
      - statusCode: 409
        body: { error: "Username or phone number already exists." }
      - statusCode: 422
        body: { error: "Invalid ID number format." }
  dependencies:
    - DB-CreateUser
  acceptanceCriteria:
    - 当接收到合法且未注册的数据时，应返回201 Created。
    - 当用户名或手机号已存在时，应返回409 Conflict。
    - 密码确认不一致时返回400错误。
    - 必须同意服务条款才能注册。
  changeLog:
    - date: "2025-01-20"
      description: "初始创建。"

- type: Backend
  id: API-POST-Logout
  route: POST /api/auth/logout
  description: 处理用户登出请求，使JWT令牌失效。
  input:
    type: JSON
    headers:
      Authorization: "Bearer {token}"
  output:
    success:
      statusCode: 200
      body: { message: "Logout successful" }
    error:
      - statusCode: 401
        body: { error: "Invalid or expired token." }
  dependencies:
    - none
  acceptanceCriteria:
    - 成功登出后令牌应被加入黑名单。
    - 无效令牌应返回401错误。
  changeLog:
    - date: "2025-01-20"
      description: "初始创建。"

# 用户信息管理API接口
- type: Backend
  id: API-GET-UserProfile
  route: GET /api/user/profile
  description: 获取当前登录用户的基本信息。
  input:
    type: JSON
    headers:
      Authorization: "Bearer {token}"
  output:
    success:
      statusCode: 200
      body:
        userId: "uuid"
        username: "string"
        realName: "string"
        idType: "string"
        idNumber: "string"
        phone: "string"
        email: "string"
        passengerType: "string"
        verificationStatus: "string"
    error:
      - statusCode: 401
        body: { error: "Unauthorized access." }
  dependencies:
    - DB-FindUserByCredentials
  acceptanceCriteria:
    - 只有已登录用户可以访问自己的信息。
    - 敏感信息（如证件号）应部分遮掩显示。
  changeLog:
    - date: "2025-01-20"
      description: "初始创建。"

- type: Backend
  id: API-PUT-UserProfile
  route: PUT /api/user/profile
  description: 更新用户的基本信息（仅限可修改字段）。
  input:
    type: JSON
    headers:
      Authorization: "Bearer {token}"
    body:
      phone: string
      email: string
  output:
    success:
      statusCode: 200
      body: { message: "Profile updated successfully" }
    error:
      - statusCode: 400
        body: { error: "Invalid input format." }
      - statusCode: 401
        body: { error: "Unauthorized access." }
  dependencies:
    - DB-UpdateUserInfo
  acceptanceCriteria:
    - 只允许更新手机号和邮箱等非敏感信息。
    - 更新的手机号不能与其他用户重复。
  changeLog:
    - date: "2025-01-20"
      description: "初始创建。"

# 乘车人管理API接口
- type: Backend
  id: API-GET-Passengers
  route: GET /api/user/passengers
  description: 获取当前用户的所有乘车人信息列表。
  input:
    type: JSON
    headers:
      Authorization: "Bearer {token}"
    query:
      search: string  # 可选，按姓名或证件号搜索
  output:
    success:
      statusCode: 200
      body:
        passengers: 
          - id: "uuid"
            name: "string"
            idType: "string"
            idNumber: "string"
            phone: "string"
            verificationStatus: "string"
    error:
      - statusCode: 401
        body: { error: "Unauthorized access." }
  dependencies:
    - DB-GetUserPassengers
  acceptanceCriteria:
    - 只返回当前用户添加的乘车人。
    - 支持按姓名或证件号进行搜索过滤。
  changeLog:
    - date: "2025-01-20"
      description: "初始创建。"

- type: Backend
  id: API-POST-Passenger
  route: POST /api/user/passengers
  description: 为当前用户添加新的乘车人。
  input:
    type: JSON
    headers:
      Authorization: "Bearer {token}"
    body:
      name: string
      idType: string
      idNumber: string
      phone: string
      passengerType: string
  output:
    success:
      statusCode: 201
      body: 
        passengerId: "uuid"
        message: "Passenger added successfully"
    error:
      - statusCode: 400
        body: { error: "Invalid passenger information." }
      - statusCode: 401
        body: { error: "Unauthorized access." }
      - statusCode: 409
        body: { error: "Passenger with this ID already exists." }
  dependencies:
    - DB-CreatePassenger
  acceptanceCriteria:
    - 证件号码不能与该用户的其他乘车人重复。
    - 证件号码格式必须有效。
  changeLog:
    - date: "2025-01-20"
      description: "初始创建。"

- type: Backend
  id: API-PUT-Passenger
  route: PUT /api/user/passengers/{passengerId}
  description: 更新指定乘车人的信息。
  input:
    type: JSON
    headers:
      Authorization: "Bearer {token}"
    body:
      name: string
      idType: string
      idNumber: string
      phone: string
      passengerType: string
  output:
    success:
      statusCode: 200
      body: { message: "Passenger updated successfully" }
    error:
      - statusCode: 400
        body: { error: "Invalid passenger information." }
      - statusCode: 401
        body: { error: "Unauthorized access." }
      - statusCode: 404
        body: { error: "Passenger not found." }
  dependencies:
    - DB-UpdatePassenger
  acceptanceCriteria:
    - 只能更新属于当前用户的乘车人。
    - 证件号码修改后需要重新核验。
  changeLog:
    - date: "2025-01-20"
      description: "初始创建。"

- type: Backend
  id: API-DELETE-Passenger
  route: DELETE /api/user/passengers/{passengerId}
  description: 删除指定的乘车人。
  input:
    type: JSON
    headers:
      Authorization: "Bearer {token}"
  output:
    success:
      statusCode: 200
      body: { message: "Passenger deleted successfully" }
    error:
      - statusCode: 401
        body: { error: "Unauthorized access." }
      - statusCode: 404
        body: { error: "Passenger not found." }
      - statusCode: 409
        body: { error: "Cannot delete passenger with active orders." }
  dependencies:
    - DB-DeletePassenger
  acceptanceCriteria:
    - 只能删除属于当前用户的乘车人。
    - 有未完成订单的乘车人不能删除。
  changeLog:
    - date: "2025-01-20"
      description: "初始创建。"

# 订单管理API接口
- type: Backend
  id: API-GET-Orders
  route: GET /api/user/orders
  description: 获取当前用户的订单列表，支持按状态筛选。
  input:
    type: JSON
    headers:
      Authorization: "Bearer {token}"
    query:
      status: string  # 可选，订单状态筛选
      type: string    # 可选，未出行/历史订单
  output:
    success:
      statusCode: 200
      body:
        orders:
          - orderId: "uuid"
            orderDate: "datetime"
            trainNumber: "string"
            departure: "string"
            arrival: "string"
            departureTime: "datetime"
            arrivalTime: "datetime"
            passengerName: "string"
            seatInfo: "string"
            price: "decimal"
            status: "string"
    error:
      - statusCode: 401
        body: { error: "Unauthorized access." }
  dependencies:
    - DB-GetUserOrders
  acceptanceCriteria:
    - 只返回当前用户的订单。
    - 支持按状态和类型进行筛选。
    - 订单按创建时间倒序排列。
  changeLog:
    - date: "2025-01-20"
      description: "初始创建。"

- type: Backend
  id: API-POST-OrderPayment
  route: POST /api/orders/{orderId}/payment
  description: 处理订单支付请求。
  input:
    type: JSON
    headers:
      Authorization: "Bearer {token}"
    body:
      paymentMethod: string
      paymentInfo: object
  output:
    success:
      statusCode: 200
      body: 
        paymentId: "uuid"
        message: "Payment processed successfully"
    error:
      - statusCode: 400
        body: { error: "Invalid payment information." }
      - statusCode: 401
        body: { error: "Unauthorized access." }
      - statusCode: 404
        body: { error: "Order not found." }
      - statusCode: 409
        body: { error: "Order already paid or cancelled." }
  dependencies:
    - DB-UpdateOrderStatus
  acceptanceCriteria:
    - 只能支付属于当前用户且状态为"待支付"的订单。
    - 支付成功后订单状态更新为"已支付"。
  changeLog:
    - date: "2025-01-20"
      description: "初始创建。"